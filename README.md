-----

# リアルタイム脳波解析システム (ESP32 + Flutter + Python Server)

このプロジェクトは、自作の8チャンネル脳波計（ESP32-S3）で取得したデータを、スマートフォンアプリを介してWindowsサーバーに送信し、**MNE-Pythonライブラリ**でリアルタイムに解析・可視化するフルスタックアプリケーションです。

-----

## ✨ 主な機能

  - **ハードウェア**: Seeed Studio XIAO ESP32S3 を用いた8チャンネル脳波データ取得
  - **データ圧縮**: **zstandardライブラリ**による高効率なデータ圧縮・転送
  - **リアルタイム通信**: **BLE**による安定したデータストリーミング（ACKフロー制御付き）
  - **スマホアプリ (Flutter)**:
      - 生波形（8ch）のリアルタイムスクロール表示
      - サーバーで解析された結果（画像・数値）の表示
  - **サーバーサイド解析 (Python)**:
      - **SQLite**データベースへのデータ永続化
      - 周波数スペクトル解析 (**PSD**): 各チャンネルのパワースペクトルを色分け表示
      - 同期度解析 (**Coherence**): 電極間の結合度を円グラフで可視化

-----

## 🚀 アーキテクチャ

本システムは、役割を明確に分離した3つのコンポーネントで構成されています。

  * **Firmware (ESP32)**: センサーデータの取得、タイムスタンプ付与、圧縮に専念します。
  * **Mobile App (Flutter)**: ESP32とサーバーを中継し、生波形と解析結果の両方を表示するユーザーインターフェースです。
  * **Server (Python)**: データを受け取ってDBに保存し、バックグラウンドでMNEによる重い解析処理を実行します。

-----

## 🔧 開発環境のセットアップ

このリポジトリをクローンした後、各コンポーネントを以下の手順でセットアップしてください。

### 1\. Server (Python / Windows)

解析の心臓部となるPythonサーバーをセットアップします。

```bash
# /server ディレクトリに移動
cd server

# 仮想環境を作成
python -m venv venv

# 仮想環境を有効化
.\venv\Scripts\activate

# 必要なライブラリをすべてインストール
pip install -r requirements.txt

# サーバーを起動
python server.py
```

> **注意:** 起動時に警告が出る場合がありますが、動作には影響ありません。サーバーが `http://0.0.0.0:5000` でリクエストを待ち受けます。

-----

### 2\. Firmware (ESP32)

**PlatformIO**を使用したESP32のファームウェアです。

1.  **VSCodeで開く**: このリポジトリのルートフォルダを開きます。
2.  **ビルド & アップロード**: PlatformIO拡張機能が自動的に `/firmware` ディレクトリをプロジェクトとして認識します。
      - チェックマーク（✔）アイコンでビルドします。
      - 矢印（→）アイコンでESP32にファームウェアを書き込みます。

-----

### 3\. Mobile App (Flutter)

リアルタイム表示とサーバーへのデータ中継を行うスマホアプリです。

1.  **サーバーIPアドレスの設定**:
    `mobile_app/lib/analysis_provider.dart` ファイルを開き、`serverIp` 定数の値を、サーバーを起動しているPCのIPアドレスに書き換えてください。

    ```dart
    // 例:
    const String serverIp = "192.168.1.10";
    ```

2.  **ライブラリのインストール**:

    ```bash
    # /mobile_app ディレクトリに移動
    cd mobile_app

    # 依存パッケージを取得
    flutter pub get
    ```

3.  **アプリの実行**:
    Androidの実機をPCに接続し、以下の設定を完了してください。

      - **USBデバッグを有効化**:
        1.  「設定」\>「デバイス情報」\>「ビルド番号」を7回タップして開発者向けオプションを有効化。
        2.  「設定」\>「システム」\>「開発者向けオプション」から「USBデバッグ」を一度オフにし、再度オンに切り替えます。
      - **USB接続モードの確認**:
        USB接続モードが **ファイル転送 / Android Auto** になっていることを確認します。

    準備が完了したら、以下のコマンドでアプリを起動します。

    ```bash
    flutter run
    ```

-----

## ⚙️ `.gitignore` の設定

リポジトリをクリーンに保つため、各プロジェクトフォルダに以下の内容で `.gitignore` ファイルを作成してください。

#### `/firmware/.gitignore`

```gitignore
.pio/
.vscode/
```

#### `/mobile_app/.gitignore`

> **注意**: Flutterが自動生成するデフォルトの `.gitignore` をそのまま使用してください。

#### `/server/.gitignore`

```gitignore
venv/
__pycache__/
*.pyc
eeg_data.db
```
